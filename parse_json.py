import json

'''
Parses a nested JSON of the same object type
'data' is as-of-now hardcoded nested json field
if json_obj[field] is a list we recursively parse the json_child objects
'''
def un_nest_json(json_obj, result_array):
    if type(json_obj) is dict:
        if type(json_obj['data']) is list:
            result_array.append(json_obj)
            for json_child in json_obj['data']:
                if type(json_child['data']) is list:
                    result_array.append(json_child)
                    un_nest_json(json_child['data'], result_array)
                else:
                    result_array.append(json_child)
        else:
            result_array.append(json_obj)
    else:
        for json_child in json_obj:
            un_nest_json(json_child, result_array)
    return result_array


def parse_json_to_sql_insert(json_string):
    try:
        json_nested = json.loads(json_string)
    except json.JSONDecodeError:
        print("Error: json_string does not contain valid JSON")
        return None

    json_parsed = un_nest_json(json_nested, [])

    # hardcoded table name
    table_name = 'data'
    # get single array object
    table_data_sample = json_parsed[0]
    # parse array object to determine column names and types. Needs better logic to captre dates, emails, etc
    column_descriptors = []
    for field, value in table_data_sample.items():
        if type(value) is int:
            field_type = 'BIGINT'
        elif type(value) is float:
            field_type = 'DOUBLE'
        elif type(value) is str:
            field_type = 'STRING'
        elif type(value) is bool:
            field_type = 'BOOLEAN'
        column_descriptors.append({'name': field, 'type': field_type})
    print(f'Column descriptors are: {column_descriptors}')
    # create a create table script. Need to adapt to sql dialect
    create_table_string = ''.join([f'CREATE TABLE {table_name} IF NOT EXISTS(', ','.join([f'{col["name"]} {col["type"]}' for col in column_descriptors]), ')'])
    print(f'Create table string is: {create_table_string}')
    insert_table_string = ''.join([f'INSERT INTO {table_name} (', ','.join([f'{col["name"]}' for col in column_descriptors]), ')', ' VALUES (', ','.join((''.join(['(', ','.join([str(value) for value in row]) ,')']) for row in [list(row.values()) for row in json_parsed])), ')'])
    print(f'Insert table string is: {insert_table_string}')

parse_json_to_sql_insert('{"object_type":2,"id": "some_id_text","data":[{"object_type":2,"id": "some_id_text","data":[{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0}],"object_type":2},{"object_type":0,"id": "some_id_text","data":"Noyourenot!","object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":"","object_type":0},{"object_type":0,"id": "some_id_text","data":0.0,"object_type":0}],"object_type":2}],"object_type":1},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":"","object_type":0},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":0.0,"object_type":0},{"object_type":0,"id": "some_id_text","data":0.0,"object_type":0}],"object_type":2}],"object_type":1}],"object_type":2}],"object_type":1},{"object_type":2,"id": "some_id_text","data":[{"object_type":0,"id": "some_id_text","data":"Straw","object_type":0},{"object_type":0,"id": "some_id_text","data":0.01,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":0.01,"object_type":0},{"object_type":0,"id": "some_id_text","data":"","object_type":0}],"object_type":2},{"object_type":0,"id": "some_id_text","data":0.01,"object_type":0},{"object_type":0,"id": "some_id_text","data":0.0,"object_type":0},{"object_type":0,"id": "some_id_text","data":0.0,"object_type":0},{"object_type":0,"id": "some_id_text","data":"","object_type":0},{"object_type":0,"id": "some_id_text","data":"Yes","object_type":0},{"object_type":0,"id": "some_id_text","data":true,"object_type":0},{"object_type":0,"id": "some_id_text","data":10,"object_type":0},{"object_type":0,"id": "some_id_text","data":1,"object_type":0},{"object_type":0,"id": "some_id_text","data":1,"object_type":0},{"object_type":0,"id": "some_id_text","data":1,"object_type":0},{"object_type":0,"id": "some_id_text","data":1,"object_type":0},{"object_type":0,"id": "some_id_text","data":0,"object_type":0},{"object_type":2,"id": "some_id_text","data":[{"object_type":0,"id": "some_id_text","data":1.0,"object_type":0},{"object_type":0,"id": "some_id_text","data":20.0,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0}],"object_type":2},{"object_type":2,"id": "some_id_text","data":[{"object_type":0,"id": "some_id_text","data":1.0,"object_type":0},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":5.0,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0}],"object_type":2},{"object_type":2,"id":1,"data":[{"object_type":0,"id": "some_id_text","data":5.0,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0}],"object_type":2},{"object_type":2,"id":2,"data":[{"object_type":0,"id": "some_id_text","data":5.0,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0}],"object_type":2}],"object_type":1},{"object_type":0,"id": "some_id_text","data":0,"object_type":0}],"object_type":2},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":2,"id": "some_id_text","data":[{"object_type":0,"id": "some_id_text","data":"PD","object_type":0},{"object_type":0,"id": "some_id_text","data":"AllPerils","object_type":0},{"object_type":0,"id": "some_id_text","data":"WW","object_type":0}],"object_type":2},{"object_type":0,"id": "some_id_text","data":0.0,"object_type":0}],"object_type":2}],"object_type":1},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":2,"id": "some_id_text","data":[{"object_type":0,"id": "some_id_text","data":"PD","object_type":0},{"object_type":0,"id": "some_id_text","data":"AllPerils","object_type":0},{"object_type":0,"id": "some_id_text","data":"WW","object_type":0}],"object_type":2},{"object_type":0,"id": "some_id_text","data":0.0,"object_type":0}],"object_type":2}],"object_type":1},{"object_type":2,"id": "some_id_text","data":[{"object_type":0,"id": "some_id_text","data":"A","object_type":0},{"object_type":0,"id": "some_id_text","data":"AllPerils","object_type":0}],"object_type":2},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":"defaultbuilding","object_type":0},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":"PD","object_type":0},{"object_type":0,"id": "some_id_text","data":"AllPerils","object_type":0},{"object_type":0,"id": "some_id_text","data":"WW","object_type":0},{"object_type":0,"id": "some_id_text","data":0.0,"object_type":0}],"object_type":2},{"object_type":2,"id":1,"data":[{"object_type":0,"id": "some_id_text","data":"PD","object_type":0},{"object_type":0,"id": "some_id_text","data":"AllPerils","object_type":0},{"object_type":0,"id": "some_id_text","data":"WW","object_type":0},{"object_type":0,"id": "some_id_text","data":0.0,"object_type":0}],"object_type":2}],"object_type":1}],"object_type":2}],"object_type":1},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":"defaultbuilding","object_type":0},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":"PD","object_type":0},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":"AllPerils","object_type":0},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":"WW","object_type":0},{"object_type":0,"id": "some_id_text","data":0.0,"object_type":0}],"object_type":2}],"object_type":1}],"object_type":2}],"object_type":1}],"object_type":2},{"object_type":2,"id":1,"data":[{"object_type":0,"id": "some_id_text","data":"BI","object_type":0},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":"AllPerils","object_type":0},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":"WW","object_type":0},{"object_type":0,"id": "some_id_text","data":0.0,"object_type":0}],"object_type":2}],"object_type":1}],"object_type":2}],"object_type":1}],"object_type":2}],"object_type":1}],"object_type":2}],"object_type":1},{"object_type":0,"id": "some_id_text","data":"2018-01-01","object_type":0},{"object_type":0,"id": "some_id_text","data":"2018-12-31","object_type":0},{"object_type":0,"id": "some_id_text","data":364,"object_type":0},{"object_type":0,"id": "some_id_text","data":10,"object_type":0},{"object_type":0,"id": "some_id_text","data":"string","object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0},{"object_type":2,"id": "some_id_text","data":[{"object_type":0,"id": "some_id_text","data":3,"object_type":0},{"object_type":0,"id": "some_id_text","data":5,"object_type":0},{"object_type":0,"id": "some_id_text","data":4,"object_type":0},{"object_type":2,"id": "some_id_text","data":[{"object_type":1,"id": "some_id_text","data":[],"object_type":1},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":null,"object_type":0}],"object_type":2}],"object_type":1},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":null,"object_type":0}],"object_type":2}],"object_type":1}],"object_type":2}],"object_type":2},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":0,"object_type":0},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":0,"object_type":0},{"object_type":1,"id": "some_id_text","data":[{"object_type":2,"id":0,"data":[{"object_type":0,"id": "some_id_text","data":0,"object_type":0}],"object_type":2}],"object_type":1}],"object_type":2}],"object_type":1}],"object_type":2}],"object_type":1},{"object_type":2,"id": "some_id_text","data":[{"object_type":0,"id": "some_id_text","data":"2018-01-01","object_type":0},{"object_type":0,"id": "some_id_text","data":"2018-12-31","object_type":0},{"object_type":0,"id": "some_id_text","data":10000.0,"object_type":0},{"object_type":0,"id": "some_id_text","data":12000.0,"object_type":0},{"object_type":0,"id": "some_id_text","data":"GBP","object_type":0},{"object_type":0,"id": "some_id_text","data":0.5833333333333334,"object_type":0},{"object_type":0,"id": "some_id_text","data":null,"object_type":0}],"object_type":2}],"object_type":2}')
